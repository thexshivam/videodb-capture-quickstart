<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Meeting Copilot</title>
    <!-- Material Icons for history clock -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- HLS.js for in-app video playback -->
    <!-- HLS.js for in-app video playback -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://jsmpeg.com/jsmpeg.min.js"></script>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="./src/styles/main.css">
</head>

<body>
    <!-- Main App View -->
    <div id="mainApp" class="view-container active">
        <!-- Sidebar + Workspace Layout -->
        <div style="display: flex; height: 100vh; overflow: hidden;">

            <!-- Left Sidebar -->
            <div
                style="width: 300px; background: #252526; border-right: 1px solid #404040; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;">

                <!-- Brand -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <img src="img/logo.jpeg" alt="VideoDB" style="height: 28px; border-radius: 4px;">
                    <h1 style="margin: 0; font-size: 18px; font-weight: 600; color: #fff;">Meeting Copilot</h1>
                </div>

                <!-- Status Indicator -->
                <div
                    style="background: #1e1e1e; border: 1px solid #333; border-radius: 6px; padding: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <div id="healthDot" style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%;"></div>
                    <span id="statusText" style="font-size: 13px; color: #ccc;">Ready</span>
                </div>

                <!-- Main Action Button -->
                <button id="btn-start-session"
                    style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>▶</span> Start Session
                </button>
                <button id="btn-stop-session"
                    style="width: 100%; padding: 12px; background: #f44336; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 20px; display: none; align-items: center; justify-content: center; gap: 8px;">
                    <span>⏹</span> Stop Session
                </button>

                <div style="height: 1px; background: #333; margin: 10px 0;"></div>

                <!-- Stream Controls -->
                <div style="margin-bottom: 20px;">
                    <div
                        style="font-size: 11px; text-transform: uppercase; color: #888; margin-bottom: 12px; font-weight: 600; letter-spacing: 0.5px;">
                        Source Controls</div>

                    <!-- Mic -->
                    <div
                        style="background: #1e1e1e; border: 1px solid #333; border-radius: 6px; padding: 10px 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: #ccc;">
                            <img src="img/voice-recording.png" alt="Mic"
                                style="width: 16px; height: 16px; opacity: 0.8;">
                            <span>Microphone</span>
                        </div>
                        <label style="position: relative; display: inline-block; width: 36px; height: 20px;">
                            <input type="checkbox" id="toggle-mic" disabled style="opacity: 0; width: 0; height: 0;">
                            <span
                                style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .3s; border-radius: 20px;">
                                <span
                                    style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%;"></span>
                            </span>
                        </label>
                    </div>

                    <!-- Screen -->
                    <div
                        style="background: #1e1e1e; border: 1px solid #333; border-radius: 6px; padding: 10px 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: #ccc;">
                            <img src="img/rec-button.png" alt="Screen" style="width: 16px; height: 16px; opacity: 0.8;">
                            <span>Screen</span>
                        </div>
                        <label style="position: relative; display: inline-block; width: 36px; height: 20px;">
                            <input type="checkbox" id="toggle-screen" disabled style="opacity: 0; width: 0; height: 0;">
                            <span
                                style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .3s; border-radius: 20px;">
                                <span
                                    style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%;"></span>
                            </span>
                        </label>
                    </div>

                    <!-- System Audio -->
                    <div
                        style="background: #1e1e1e; border: 1px solid #333; border-radius: 6px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: #ccc;">
                            <img src="img/volume.png" alt="Audio" style="width: 16px; height: 16px; opacity: 0.8;">
                            <span>System Audio</span>
                        </div>
                        <label style="position: relative; display: inline-block; width: 36px; height: 20px;">
                            <input type="checkbox" id="toggle-audio" disabled style="opacity: 0; width: 0; height: 0;">
                            <span
                                style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .3s; border-radius: 20px;">
                                <span
                                    style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%;"></span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Recording Timer (Bottom) -->
                <div id="recordingTimer" style="margin-top: auto; margin-bottom: 15px;">00:00:00</div>

                <!-- Footer -->
                <div
                    style="border-top: 1px solid #333; padding-top: 15px; display: flex; align-items: center; justify-content: space-between;">
                    <div class="user-profile-container" id="userProfileContainer"
                        style="position: relative; display: flex; align-items: center; cursor: pointer;">
                        <img src="img/profile.png" class="user-icon" alt="Profile">
                        <span class="user-tooltip" id="userNameTooltip">Loading...</span>
                        <div class="profile-menu" id="profileMenu">
                            <div class="profile-menu-header" id="menuUserName">Loading...</div>
                            <button class="profile-menu-item logout" id="menuLogoutBtn">
                                <img src="img/log-out.png" class="logout-icon-img" alt="Logout"> Log Out
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="historyBtn" class="settings-btn btn-history" title="History">
                            <img src="img/history.png" class="settings-icon-img" alt="History">
                        </button>
                        <button id="settingsBtn" class="settings-btn btn-settings" title="Settings">
                            <img src="img/setting.png" class="settings-icon-img" alt="Settings">
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Workspace -->
            <div
                style="flex: 1; display: flex; flex-direction: column; background: #1e1e1e; height: 100vh; overflow: hidden;">
                <!-- Tabs -->
                <div id="tab-container"
                    style="flex: 0 0 auto; display: flex; gap: 20px; border-bottom: 1px solid #404040; background: #2d2d2d; padding: 0 20px; position: relative;">
                    <button class="tab-btn active" data-tab="transcriptions"
                        style="background: none; border: none; color: #4CAF50; padding: 10px 0; font-size: 14px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="img/transcription.png" style="width: 16px; height: 16px;">
                        Live Session
                    </button>
                    <button class="tab-btn" data-tab="logs"
                        style="background: none; border: none; color: #888; padding: 10px 0; font-size: 14px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="img/history.png" style="width: 16px; height: 16px;">
                        Logs
                    </button>
                    <span class="tab-glider"></span>
                </div>

                <!-- Content Areas -->
                <div id="transcriptions" class="tab-content active"
                    style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">

                    <!-- Player Area (Fixed, Won't Scroll) -->
                    <div style="flex: 0 0 auto; border-bottom: 1px solid #404040;">
                        <!-- Always Visible: Player Subheader -->
                        <div id="player-subheader" class="player-subheader"
                            style="display: block; padding: 6px 12px; background: #252526; cursor: pointer; user-select: none; border-bottom: 1px solid #333;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span class="live-dot" style="width: 6px; height: 6px;"></span>
                                    <span style="font-size: 12px; font-weight: 500; color: #ccc;">Live Preview</span>
                                </div>
                                <button id="toggle-player-btn" class="icon-btn" title="Toggle Player"
                                    style="padding: 2px;">
                                    <span class="material-icons" style="font-size: 18px;">expand_more</span>
                                </button>
                            </div>
                        </div>

                        <!-- Player Section (Collapsible) -->
                        <div id="live-player-section" style="display: none; background: #000;">
                            <!-- Video Container -->
                            <div style="position: relative; width: 100%; height: 400px; background: #000;">
                                <!-- Canvas for jsmpeg (low-latency) -->
                                <canvas id="live-player-canvas"
                                    style="width: 100%; height: 100%; object-fit: contain; display: none;"></canvas>
                                <!-- Video for HLS fallback -->
                                <video id="live-player" controls autoplay playsinline muted
                                    style="width: 100%; height: 100%; object-fit: contain; display: none;"></video>
                                <div id="player-overlay"
                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888;">
                                    Connecting...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transcription Container (Scrolls Independently) -->
                    <div id="transcription-container"
                        style="flex: 1; min-height: 0; overflow-y: auto; background: #1e1e1e;">
                        <div id="transcriptionList"
                            style="padding: 20px 24px; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px;">
                            <div class="empty-state"
                                style="color: #555; text-align: center; margin-top: 50px; font-style: italic;">
                                Ready to capture.<br>Start a session to see real-time transcription.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="logs" class="tab-content" style="flex: 1; overflow-y: auto; padding: 20px; display: none;">
                    <div id="logContainer"
                        style="font-family: 'SF Mono', 'Roboto Mono', 'Courier New', monospace; font-size: 12px; color: #d4d4d4; white-space: pre-wrap; line-height: 1.4;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History View -->
    <div id="historyView" class="view-container">
        <div class="history-nav">
            <button id="backToWorkspaceBtn" class="icon-btn" title="Back to Workspace">
                <img src="img/back.png" alt="Back" style="width: 24px; height: 24px; opacity: 0.8;">
            </button>
            <div style="font-size: 16px; font-weight: 600; color: #fff;">Session History</div>
        </div>

        <div class="history-content">
            <!-- Sidebar List -->
            <div class="history-sidebar">
                <div class="history-list-header">
                    Recent Sessions
                </div>
                <div id="historyListContainer">
                    <!-- Items injected here -->
                    <div style="padding: 20px; text-align: center; color: #666; font-style: italic;">
                        Loading history...
                    </div>
                </div>
            </div>

            <!-- Main Content (Player + Insights) -->
            <div class="history-main">
                <!-- Video Player Section -->
                <div class="history-player-container">
                    <video id="historyVideoPlayer" controls playsinline>
                        <p>Your browser does not support HTML5 video.</p>
                    </video>
                </div>

                <!-- Tabs Section (Insights) -->
                <div class="history-info-tabs">
                    <div class="tabs-header">
                        <button class="history-tab-btn active">Insights</button>
                        <!-- <button class="history-tab-btn">Chat</button> -->
                    </div>
                    <div class="tab-body" id="insightsContent">
                        <div style="text-align: center; color: #666; margin-top: 40px;">
                            <span class="material-icons" style="font-size: 48px; opacity: 0.2;">auto_awesome</span>
                            <p>Select a session to view AI insights</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content" style="text-align: left; width: 450px;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="margin:0; color: #fff; font-size: 18px;">Settings</h2>
                <button id="closeSettingsBtn"
                    style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <div class="config-group">
                <label for="settings-backend-url"
                    style="display:block; font-size:12px; color:#aaa; margin-bottom:4px;">Backend URL</label>
                <input type="text" id="settings-backend-url" class="modal-input" disabled>
            </div>
            <div class="config-group" style="margin-bottom: 20px;">
                <label for="settings-callback-url"
                    style="display:block; font-size:12px; color:#aaa; margin-bottom:4px;">Callback URL</label>
                <input type="text" id="settings-callback-url" class="modal-input"
                    placeholder="https://your-server.com/webhook">
            </div>

            <button id="saveSettingsBtn" class="primary-btn">Save Changes</button>
        </div>
    </div>

    <!-- Auth Modal (Legacy Fallback) -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-content" style="width: 400px; text-align: center;">
            <img src="./img/logo.jpeg" alt="VideoDB" style="height: 40px; margin-bottom: 15px; border-radius: 8px;">
            <div class="modal-title">Connect to VideoDB</div>
            <div class="modal-subtitle" id="authModalSubtitle">
                Please enter your VideoDB API Key to continue.
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-size: 11px; font-weight: 600; color: #888;">API KEY</label>
                    <a href="#" onclick="window.configAPI.openExternalLink('https://console.videodb.io/dashboard')"
                        style="font-size: 11px; color: #4CAF50; text-decoration: none; font-weight: 500;">
                        Get API Key ↗
                    </a>
                </div>
                <input type="password" id="authApiKeyInput" class="modal-input" placeholder="sk-..."
                    style="font-family: monospace;">
            </div>

            <div id="authError" class="error-message" style="margin-top: 15px;"></div>

            <button id="authConnectBtn" class="primary-btn" style="width: 100%; margin-top: 20px;">
                Connect
            </button>
        </div>
    </div>

    <!-- Startup Wizard (Mic Setup) -->
    <div id="startupWizard" class="modal-overlay" style="display: none; z-index: 3000;">
        <div class="wizard-card">
            <!-- Hero Video -->
            <div class="wizard-hero">
                <img src="./img/tutorial_mic.webp" class="wizard-video">
                <div class="wizard-hero-overlay"></div>
            </div>

            <!-- Content -->
            <div class="wizard-content">
                <div class="wizard-header">
                    <h2>Microphone Setup</h2>
                    <p>Accurate audio transcription requires permission to access your microphone.</p>
                </div>

                <!-- Status/Instructions (Hidden by default) -->
                <div id="wizard-status" class="wizard-status" style="display: none;">
                    <div class="status-icon">⚠️</div>
                    <div class="status-text">
                        <strong>Permission Denied</strong>
                        <span>Open <b>System Settings</b> > <b>Privacy</b> to enable.</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="wizard-actions">
                    <button id="btn-wizard-grant" class="primary-btn pulse-btn">
                        Grant Access
                    </button>
                    <!-- Settings Button (Hidden) -->
                    <button id="btn-wizard-settings" class="secondary-btn" style="display: none;">
                        Open Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./renderer.js"></script>
</body>

</html>